{% extends 'base.html' %}

{% block content %}
<!-- Hero Section -->
<section class="min-h-[70vh] flex flex-col items-center justify-center text-center relative z-10 py-16">
    <!-- Abstract Blobs Background -->
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-moss/10 rounded-blob blur-3xl -z-10 animate-pulse">
    </div>

    <div class="organic-card p-12 max-w-4xl w-full backdrop-blur-xl border border-white/50 bg-white/60">
        <h1 class="text-5xl md:text-7xl mb-6 text-charcoal leading-tight drop-shadow-sm">
            Selamat Datang di <br>
            <span class="text-moss italic relative inline-block mt-2">Desa Ciawi Asih</span>
        </h1>

        <p class="font-sans text-xl md:text-2xl mb-10 text-charcoal/80 font-medium tracking-wide">
            Melayani dengan hati, transparan, dan terhubung secara digital.
        </p>

        <div class="flex flex-col md:flex-row gap-6 justify-center items-center">
            <a href="#layanan" class="btn-organic btn-primary group">
                Ajukan Surat <i class="fas fa-arrow-right ml-2 group-hover:translate-x-1 transition-transform"></i>
            </a>
            <a href="#statistik" class="btn-organic btn-secondary">
                Lihat Statistik <i class="fas fa-chart-pie ml-2 text-clay"></i>
            </a>
        </div>
    </div>
</section>

<!-- Statistik Section (Organic Cards) -->
<section id="statistik" class="py-24">
    <div class="text-center mb-16 stagger-anim">
        <h2 class="text-4xl text-charcoal mb-4">Statistik Kependudukan</h2>
        <div class="h-1 w-24 bg-moss/30 mx-auto rounded-full"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <!-- Card 1 -->
        <div
            class="organic-card p-8 flex flex-col items-center text-center radius-blob-3 bg-gradient-to-br from-white to-mist/50">
            <h3 class="font-serif text-lg text-moss mb-2">Total Penduduk</h3>
            <p class="font-sans text-5xl font-bold text-charcoal mb-1">{{ stats.penduduk }}</p>
            <p class="text-sm uppercase tracking-widest text-charcoal/50">Jiwa</p>
        </div>
        <!-- Card 2 -->
        <div class="organic-card p-8 flex flex-col items-center text-center rounded-[3rem] bg-white">
            <h3 class="font-serif text-lg text-clay mb-2">Kepala Keluarga</h3>
            <p class="font-sans text-5xl font-bold text-charcoal mb-1">{{ stats.kk }}</p>
            <p class="text-sm uppercase tracking-widest text-charcoal/50">KK</p>
        </div>
        <!-- Card 3 -->
        <div class="organic-card p-8 flex flex-col items-center text-center rounded-3xl bg-white">
            <h3 class="font-serif text-lg text-moss mb-2">Laki-Laki</h3>
            <p class="font-sans text-5xl font-bold text-charcoal mb-1">{{ stats.laki }}</p>
            <p class="text-sm uppercase tracking-widest text-charcoal/50">Orang</p>
        </div>
        <!-- Card 4 -->
        <div
            class="organic-card p-8 flex flex-col items-center text-center radius-blob-1 bg-gradient-to-fl from-white to-sand/20">
            <h3 class="font-serif text-lg text-clay mb-2">Perempuan</h3>
            <p class="font-sans text-5xl font-bold text-charcoal mb-1">{{ stats.perempuan }}</p>
            <p class="text-sm uppercase tracking-widest text-charcoal/50">Orang</p>
        </div>
    </div>
</section>

<!-- Layanan Section -->
<section id="layanan" class="py-20 relative">
    <!-- Soft Background Blob -->
    <div class="absolute right-0 top-1/2 -translate-y-1/2 w-96 h-96 bg-clay/5 rounded-full blur-3xl -z-10"></div>

    <div class="text-center mb-16 stagger-anim">
        <h2 class="text-4xl md:text-5xl text-charcoal mb-4">Layanan Surat Online</h2>
        <p class="font-sans text-xl text-charcoal/70 max-w-2xl mx-auto">
            Urus administrasi desa tanpa perlu antri. Cukup dari rumah, cepat dan mudah.
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
        {% if jenis_surat %}
        {% for surat in jenis_surat %}
        <!-- Organic Service Card -->
        <div class="organic-card p-8 group relative overflow-hidden bg-white/80">
            <div
                class="absolute -right-6 -top-6 w-24 h-24 bg-moss/10 rounded-full group-hover:scale-150 transition-transform duration-500">
            </div>

            <div
                class="w-14 h-14 bg-mist rounded-2xl flex items-center justify-center text-moss text-2xl mb-6 shadow-sm group-hover:bg-moss group-hover:text-white transition-colors duration-300 relative z-10">
                {% if 'Kematian' in surat.nama_surat %}
                <i class="fas fa-ribbon"></i>
                {% elif 'KTP' in surat.nama_surat %}
                <i class="fas fa-id-card"></i>
                {% elif 'Domisili' in surat.nama_surat %}
                <i class="fas fa-map-marker-alt"></i>
                {% elif 'SKCK' in surat.nama_surat %}
                <i class="fas fa-user-shield"></i>
                {% elif 'Penghasilan' in surat.nama_surat %}
                <i class="fas fa-money-bill-wave"></i>
                {% elif 'Belum Menikah' in surat.nama_surat %}
                <i class="fas fa-user-check"></i>
                {% elif 'Kelahiran' in surat.nama_surat %}
                <i class="fas fa-baby"></i>
                {% elif 'Ambulans' in surat.nama_surat %}
                <i class="fas fa-ambulance"></i>
                {% else %}
                <i class="fas fa-file-alt"></i>
                {% endif %}
            </div>

            <h3 class="text-2xl font-serif font-bold mb-3 group-hover:text-moss transition-colors">{{ surat.nama_surat
                }}</h3>
            <p class="text-charcoal/60 mb-8 leading-relaxed">
                Layanan mandiri pengurusan dokumen resmi {{ surat.nama_surat }}.
            </p>

            {% if session.get('loggedin') %}
            <button onclick="openModal('{{ surat.id }}', '{{ surat.nama_surat }}')"
                class="w-full py-4 rounded-full border border-timber text-moss font-bold hover:bg-moss hover:text-white hover:border-transparent transition-all shadow-sm">
                Buat Sekarang
            </button>
            {% else %}
            <a href="{{ url_for('login') }}"
                onclick="showLoginAlert(event, '{{ url_for('login') }}', 'Silakan login / daftar akun untuk mengajukan surat.')"
                class="block text-center w-full py-4 rounded-full border border-timber text-charcoal/50 font-bold hover:bg-moss hover:text-white hover:border-transparent transition-all shadow-sm">
                Login untuk Buat
            </a>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <p class="text-center w-full col-span-3 text-2xl text-charcoal/50 italic">Layanan sedang pemeliharaan.</p>
        {% endif %}
    </div>
</section>

<!-- Modal Pengajuan Surat (Organic Style) -->
<div x-data="{ open: false, namaSurat: '', idSurat: '' }"
    @open-modal-event.window="open = true; namaSurat = $event.detail.nama; idSurat = $event.detail.id" x-show="open"
    style="display: none;" class="fixed inset-0 z-[100] flex items-center justify-center px-4">

    <!-- Backdrop with blur -->
    <div x-show="open" x-transition.opacity class="absolute inset-0 bg-charcoal/20 backdrop-blur-sm"
        @click="open = false"></div>

    <!-- Modal Content -->
    <!-- Modal Content -->
    <div x-show="open" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-8 scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 scale-100"
        x-transition:leave-end="opacity-0 translate-y-8 scale-95"
        class="organic-card bg-white p-8 w-full max-w-lg relative shadow-2xl z-10">

        <h3 class="text-3xl font-serif mb-2 text-center text-moss">Formulir Pengajuan</h3>
        <p class="text-center text-charcoal/60 mb-8 border-b border-timber pb-4" x-text="namaSurat"></p>

        <form action="{{ url_for('ajukan_surat') }}" method="POST" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="id_jenis_surat" :value="idSurat">

            <div class="space-y-2">
                <label class="block font-bold text-sm text-charcoal pl-4">NIK Pemohon</label>
                <input type="text" name="nik"
                    class="input-organic bg-mist/50 focus:bg-white {{ 'cursor-not-allowed bg-gray-100' if session.get('nik') else '' }}"
                    placeholder="16 Digit NIK" required maxlength="16" value="{{ session.get('nik') or '' }}"
                    {{ 'readonly' if session.get('nik') else '' }}>
            </div>

            <div class="space-y-2">
                <label class="block font-bold text-sm text-charcoal pl-4">No. WhatsApp (Aktif)</label>
                <input type="tel" name="hp" class="input-organic bg-mist/50 focus:bg-white"
                    placeholder="Contoh: 0812..." required>
                <p class="text-xs text-charcoal/50 pl-4">Untuk notifikasi status surat.</p>
            </div>

            <div class="space-y-2">
                <label class="block font-bold text-sm text-charcoal pl-4">Keperluan Surat</label>
                <textarea name="keperluan"
                    class="input-organic h-32 rounded-3xl pt-4 bg-mist/50 focus:bg-white resize-none"
                    placeholder="Contoh: Untuk persyaratan melamar pekerjaan..." required></textarea>
            </div>

            <button type="submit" class="btn-organic btn-primary w-full text-lg shadow-lg hover:shadow-xl mt-4">
                Kirim Permohonan
            </button>
        </form>

        <button @click="open = false"
            class="absolute top-6 right-6 text-2xl text-timber hover:text-charcoal transition-colors">&times;</button>
    </div>
</div>

<!-- Section Cek Status (Baru) -->
<section id="cek-status" class="py-16 bg-mist/30">
    <div class="max-w-4xl mx-auto px-6 text-center">
        <h2 class="text-3xl font-serif text-charcoal mb-4">Lacak Permohonan Anda</h2>
        <p class="text-charcoal/70 mb-8">Sudah mengajukan surat? Masukkan NIK Anda untuk melihat progresnya.</p>

        <form action="{{ url_for('cek_status') }}" method="POST" class="relative max-w-lg mx-auto">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" name="nik_cek" placeholder="Masukkan 16 Digit NIK Anda..." required maxlength="16"
                minlength="16" pattern="\d{16}" title="Harus 16 digit angka"
                class="w-full h-16 pl-8 pr-32 rounded-full border-2 border-timber bg-white shadow-organic focus:outline-none focus:border-moss transition-all text-lg mb-2 sm:mb-0">
            {% if session.get('loggedin') %}
            <button type="submit"
                class="absolute right-2 top-2 h-12 px-8 bg-moss text-white rounded-full font-bold hover:bg-moss/90 transition-colors">
                Lacak
            </button>
            {% else %}
            <a href="{{ url_for('login') }}"
                onclick="showLoginAlert(event, '{{ url_for('login') }}', 'Silakan login untuk melacak permohonan.')"
                class="absolute right-2 top-2 h-12 px-8 bg-timber text-charcoal/60 rounded-full font-bold hover:bg-moss hover:text-white transition-colors flex items-center justify-center no-underline">
                Login
            </a>
            {% endif %}
        </form>
    </div>
</section>

<!-- Modal Hasil Cek (Otomatis muncul jika ada data) -->
{% if cek_result is defined or cek_warga is defined %}
<div id="resultModal" class="fixed inset-0 z-[110] flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-charcoal/40 backdrop-blur-sm" onclick="closeResult()"></div>

    <div
        class="organic-card bg-white p-8 w-full max-w-2xl relative shadow-2xl z-10 animate-fade-in-up max-h-[80vh] overflow-y-auto">
        <button onclick="closeResult()"
            class="absolute top-6 right-6 text-2xl text-timber hover:text-charcoal">&times;</button>

        <h3 class="text-2xl font-serif mb-6 text-center text-moss">Riwayat Permohonan</h3>

        {% if cek_warga %}
        <div class="bg-mist/30 p-4 rounded-2xl mb-6 flex items-center gap-4">
            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-moss text-xl shadow-sm">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <h4 class="font-bold text-charcoal">{{ cek_warga.nama_lengkap }}</h4>
                <p class="text-sm text-charcoal/60">NIK: {{ request.form['nik_cek'] }}</p>
            </div>
        </div>
        {% endif %}

        {% if cek_result %}
        <div class="space-y-4">
            {% for row in cek_result %}
            <div
                class="border border-timber/30 rounded-2xl p-4 hover:bg-mist/10 transition-colors relative overflow-hidden group">
                <div class="flex justify-between items-start mb-2">
                    <h5 class="font-bold text-lg text-charcoal">{{ row.nama_surat }}</h5>
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide
                        {% if row.status == 'Pending' %} bg-orange-100 text-orange-600
                        {% elif row.status == 'Disetujui' %} bg-green-100 text-green-600
                        {% else %} bg-red-100 text-red-600 {% endif %}">
                        {{ row.status }}
                    </span>
                </div>
                <p class="text-sm text-charcoal/70 mb-2">{{ row.keperluan }}</p>
                <div class="flex justify-between items-end text-xs text-charcoal/40 font-mono mt-3">
                    <span><i class="far fa-calendar mr-1"></i> {{ row.tanggal_permohonan }}</span>
                    {% if row.no_surat %}
                    <span class="text-moss font-bold"><i class="fas fa-check-circle mr-1"></i> Selesai: {{ row.no_surat
                        }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-10">
            <div class="inline-block p-4 rounded-full bg-mist/50 text-timber mb-3 text-3xl">
                <i class="far fa-folder-open"></i>
            </div>
            <p class="text-charcoal/60">Belum ada riwayat permohonan surat.</p>
        </div>
        {% endif %}

        <div class="mt-8 text-center">
            <button onclick="closeResult()" class="btn-organic btn-secondary text-sm py-2 px-6">Tutup</button>
        </div>
    </div>
</div>
<script>
    function closeResult() {
        document.getElementById('resultModal').style.display = 'none';
        // Hapus query param tracking agar refresh page bersih (opsional)
    }
    // Scroll ke section cek status jika ada hasil
    window.location.hash = "cek-status";
</script>
{% endif %}

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Scripts for Modal & Alert -->
<script>
    function openModal(id, nama) {
        window.dispatchEvent(new CustomEvent('open-modal-event', { detail: { id: id, nama: nama } }));
    }

    function showLoginAlert(event, url, message) {
        event.preventDefault();
        Swal.fire({
            title: 'Akses Terbatas',
            text: message,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Login Sekarang',
            cancelButtonText: 'Nanti',
            confirmButtonColor: '#5D7052',
            cancelButtonColor: '#A8A29E',
            background: '#FDFCF8',
            color: '#2C2C24',
            iconColor: '#5D7052',
            customClass: {
                popup: 'organic-card !p-8 border border-timber/30 shadow-2xl rounded-[2rem]',
                title: 'font-serif text-2xl text-moss mb-2',
                confirmButton: 'rounded-full px-6 py-2',
                cancelButton: 'rounded-full px-6 py-2'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
    }

    // Intercept Form Submission
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form[action="{{ url_for("ajukan_surat") }}"]');

        if (form) {
            form.addEventListener('submit', function (e) {
                // Biarkan default submit berjalan agar backend menangani respons (karena kita pakai flash message server-side sekarang)
                // Jika ingin SweetAlert client-side murni, kita harus pakai AJAX. 
                // Untuk konsistensi dengan kode sebelumnya yang pakai form submit biasa, kita gunakan SweetAlert sebagai "hiasan" sebelum submit.

                // e.preventDefault();
                // Jika pakai e.preventDefault, kita harus handling submit manual di "then" dibawah.
                // Tapi kode lama Anda:
                e.preventDefault();

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                Swal.fire({
                    title: 'Kirim Permohonan?',
                    text: 'Pastikan data yang Anda masukkan benar.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Kirim',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#5D7052',
                    cancelButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        }
    });
</script>


<!-- Flash Message Display -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% for category, message in messages %}
        Swal.fire({
            icon: {{ 'error' if category == 'danger' else 'success' | tojson }},
        title: {{ 'Perhatian' if category == 'danger' else 'Info' | tojson }},
        text: {{ message | tojson }},
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 4000,
        timerProgressBar: true,
        background: '#FDFCF8',
        color: '#2C2C24',
        iconColor: {{ '#C53030' if category == 'danger' else '#5D7052' | tojson }},
        customClass: {
        popup: 'organic-card !p-4 border border-timber/30 shadow-lg'
    }
        });
    {% endfor %}
    });
</script>
{% endif %}
{% endwith %}

{% endblock %}