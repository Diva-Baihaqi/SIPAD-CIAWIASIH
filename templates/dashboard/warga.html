{% extends 'base.html' %}

{% block content %}
<div class="py-12">
    <div class="max-w-6xl mx-auto px-4 mt-8">

        <!-- Welcome Section -->
        <div class="organic-card bg-white p-8 relative overflow-hidden mb-8">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-moss/10 rounded-full blur-2xl"></div>

            <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                <!-- Avatar -->
                <div
                    class="w-24 h-24 rounded-full bg-mist border-4 border-white shadow-lg flex items-center justify-center text-moss text-4xl shrink-0">
                    <i class="fas fa-user-circle"></i>
                </div>

                <!-- Info -->
                <div class="text-center md:text-left flex-1">
                    <h2 class="text-3xl font-serif text-charcoal mb-2">
                        Halo, {{ penduduk.nama_lengkap if penduduk else session['username'] }}!
                    </h2>
                    {% if penduduk %}
                    <p class="text-charcoal/60 font-sans flex flex-wrap justify-center md:justify-start gap-4 text-sm">
                        <span><i class="fas fa-id-card mr-1 text-moss"></i> {{ penduduk.nik }}</span>
                        <span><i class="fas fa-map-marker-alt mr-1 text-clay"></i> RT {{ penduduk.rt }} / RW {{
                            penduduk.rw }}</span>
                        <span><i class="fas fa-briefcase mr-1 text-sand-dark"></i> {{ penduduk.pekerjaan }}</span>
                    </p>
                    {% else %}
                    <p class="text-red-500 text-sm bg-red-50 px-3 py-1 rounded-full inline-block border border-red-100">
                        <i class="fas fa-exclamation-circle mr-1"></i> Akun belum terverifikasi dengan data penduduk.
                    </p>
                    {% endif %}
                </div>

                <!-- Action -->
                <div>
                    <a href="{{ url_for('logout') }}"
                        class="btn-organic text-red-500 border border-red-200 hover:bg-red-50 px-6 py-2 text-sm shadow-none">
                        <i class="fas fa-sign-out-alt mr-2"></i> Keluar
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Kolom Kiri: Layanan Cepat -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Card Buat Surat -->
                <div class="organic-card bg-gradient-to-br from-moss to-[#4a5a42] text-white p-8 text-center shadow-xl transform hover:-translate-y-1 transition-transform cursor-pointer"
                    onclick="window.location.href='/#layanan'">
                    <div
                        class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                        <i class="fas fa-plus text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-serif font-bold mb-2">Buat Surat Baru</h3>
                    <p class="text-white/80 text-sm mb-6">Ajukan surat pengantar, keterangan, atau dokumen lain secara
                        online.</p>
                    <button
                        class="bg-white text-moss px-6 py-2 rounded-full font-bold text-sm hover:bg-mist transition-colors w-full shadow-md">
                        Mulai Pengajuan
                    </button>
                </div>

                <!-- Info Desa -->
                <div class="organic-card bg-white p-6 border border-timber/20">
                    <h4 class="font-bold text-charcoal mb-4 flex items-center">
                        <i class="fas fa-bullhorn text-clay mr-2"></i> Informasi Desa
                    </h4>
                    <div class="space-y-4">
                        <div class="bg-mist/30 p-3 rounded-lg text-sm text-charcoal/70">
                            <span class="block font-bold text-moss text-xs mb-1">JADWAL PELAYANAN</span>
                            Senin - Jumat: 08.00 - 15.00 WIB
                        </div>
                        <div class="bg-mist/30 p-3 rounded-lg text-sm text-charcoal/70">
                            <span class="block font-bold text-moss text-xs mb-1">KONTAK DARURAT</span>
                            Ambulans Desa: 0812-3456-7890
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kolom Kanan: Riwayat Permohonan -->
            <div class="lg:col-span-2">
                <div class="organic-card bg-white p-8 min-h-[500px]">
                    <h3 class="font-serif text-2xl text-charcoal mb-6 flex items-center justify-between">
                        <span><i class="fas fa-history text-moss mr-2"></i> Riwayat Permohonan</span>
                        {% if riwayat %}
                        <span
                            class="text-xs font-sans font-normal bg-mist px-3 py-1 rounded-full text-charcoal/50">Total:
                            {{ riwayat|length }}</span>
                        {% endif %}
                    </h3>

                    {% if riwayat %}
                    <div class="space-y-4">
                        {% for r in riwayat %}
                        <div
                            class="group border border-timber/30 rounded-2xl p-5 hover:border-moss/50 hover:bg-mist/10 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-lg text-charcoal group-hover:text-moss transition-colors">
                                        {{ r.nama_surat }}</h4>
                                    <p class="text-sm text-charcoal/60 line-clamp-1 dark:text-gray-400">"{{ r.keperluan
                                        }}"</p>
                                </div>
                                <div>
                                    {% if r.status == 'Pending' %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold border border-yellow-200">Pending</span>
                                    {% elif r.status == 'Disetujui' %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold border border-green-200">Selesai</span>
                                    {% else %}
                                    <span
                                        class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold border border-red-200">Ditolak</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-between mt-4 pt-4 border-t border-dashed border-timber/30">
                                <div class="text-xs text-charcoal/40 font-mono">
                                    <i class="far fa-calendar-alt mr-1"></i> {{ r.created_at.strftime('%d %B %Y') }}
                                </div>

                                {% if r.status == 'Disetujui' and r.no_surat %}
                                <a href="{{ url_for('cetak_surat', id=r.id) }}" target="_blank"
                                    class="inline-flex items-center gap-2 text-moss font-bold text-sm hover:underline">
                                    <i class="fas fa-print"></i> Download Surat
                                </a>
                                {% elif r.status == 'Ditolak' %}
                                <span class="text-red-400 text-xs bg-red-50 px-2 py-1 rounded">Mohon ajukan
                                    ulang/hubungi petugas (data tidak valid)</span>
                                {% else %}
                                <span class="text-charcoal/40 text-xs italic">Menunggu verifikasi staff...</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="flex flex-col items-center justify-center h-64 text-center">
                        <div
                            class="w-16 h-16 bg-mist rounded-full flex items-center justify-center text-charcoal/20 mb-4 text-3xl">
                            <i class="far fa-folder-open"></i>
                        </div>
                        <p class="text-charcoal/50">Belum ada riwayat permohonan surat.</p>
                        <a href="/#layanan" class="text-moss font-bold text-sm mt-2 hover:underline">Buat surat pertama
                            Anda &rarr;</a>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}